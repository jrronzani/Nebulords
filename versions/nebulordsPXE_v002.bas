  ;***************************************************************
  ;  NEBULORDS PXE - Version 002
  ;  Warlords-style Space Combat with Paddle Controls
  ;
  ;  Changes from v001:
  ;  - Extended playfield to full 176 lines (was 174)
  ;  - Remapped paddle directions: 0=SSE going clockwise to 15=SE
  ;  - Updated Y boundary checks for taller playfield
  ;
  ;  Controls:
  ;  - Paddle 0/1: Direction (16 positions, 0=SSE clockwise)
  ;  - Paddle Button: Fire (not yet implemented)
  ;***************************************************************

  ;***************************************************************
  ;  PXE Kernel Setup
  ;***************************************************************
  set kernel PXE

  ; Set Playfield to full 40 pixel width
  ; Mode $fd: 40-pixel width, use PF_FRAC_INC for resolution
  PF_MODE = $fd

  ; Each line of data draws one line on screen (no fractional increment)
  PF_FRAC_INC = 0

  ; Configure paddle reading for precise control (0-128 range)
  ; 128 divides cleanly by 8 to give 16 directions
  PaddleRange0 = 128
  PaddleRange1 = 128

  ;***************************************************************
  ;  Constants
  ;***************************************************************
  const MOVE_SPEED = 1           ; Pixels per frame constant velocity
  const PADDLE_DIVISIONS = 16    ; 16-direction movement
  const DIRECTION_OFFSET = 7     ; Offset to make 0=SSE (instead of 0=N)

  ;***************************************************************
  ;  Variable declarations
  ;***************************************************************
  ; Player 1 (Paddle 0)
  dim p1_xpos = a
  dim p1_ypos = b
  dim p1_direction = c           ; Current direction (0-15)
  dim p1_xvel = d                ; X velocity (-2 to +2)
  dim p1_yvel = e                ; Y velocity (-2 to +2)

  ; Player 2 (Paddle 1)
  dim p2_xpos = f
  dim p2_ypos = g
  dim p2_direction = h           ; Current direction (0-15)
  dim p2_xvel = i                ; X velocity (-2 to +2)
  dim p2_yvel = j                ; Y velocity (-2 to +2)

  ; Temp variables
  dim temp_paddle = k            ; Temp for paddle reading
  dim temp_dir = l               ; Temp for direction calculation

  ;***************************************************************
  ;  Initialize game
  ;***************************************************************
__Game_Init
  ; Set colors
  COLUBK = $00                   ; Black background
  COLUPF = $0E                   ; White playfield border
  COLUP0 = $96                   ; Blue-purple for Player 1
  COLUP1 = $34                   ; Red-orange for Player 2

  ; Starting positions (left and right sides, centered vertically)
  p1_xpos = 30 : p1_ypos = 60
  p2_xpos = 130 : p2_ypos = 60

  ; Initial directions (facing each other - in new coordinate system)
  ; East is now direction 13, West is direction 5
  p1_direction = 13              ; East (facing right)
  p2_direction = 5               ; West (facing left)

  ; Initialize velocities to zero
  p1_xvel = 0 : p1_yvel = 0
  p2_xvel = 0 : p2_yvel = 0

  ; Draw the playfield once (static border)
  gosub __Setup_Playfield

  ;***************************************************************
  ;  Define ship sprites (13 pixels tall, based on v051)
  ;***************************************************************
  player0:
  %00111100
  %00111100
  %00111100
  %11000011
  %11011011
  %11011011
  %11011011
  %11011011
  %11011011
  %11000011
  %00111100
  %00111100
  %00111100
end

  player1:
  %00111100
  %00111100
  %00111100
  %11000011
  %11011011
  %11011011
  %11011011
  %11011011
  %11011011
  %11000011
  %00111100
  %00111100
  %00111100
end


  ;***************************************************************
  ;  MAIN LOOP
  ;***************************************************************
__Main_Loop

  ;***************************************************************
  ;  Read Paddle 0 for Player 1 direction
  ;***************************************************************
  ; PXE kernel provides direct access to Paddle0 variable
  temp_paddle = Paddle0

  ; Convert paddle value (0-128) to direction (0-15)
  ; Divide by 8 to get 16 divisions, then add offset for SSE=0
  p1_direction = temp_paddle / 8
  if p1_direction > 15 then p1_direction = 15

  ; Add direction offset to make 0=SSE (clockwise from there)
  p1_direction = (p1_direction + DIRECTION_OFFSET) & 15

  ; Set P1 velocity based on direction
  temp_dir = p1_direction
  gosub __Set_P1_Velocity

  ;***************************************************************
  ;  Read Paddle 1 for Player 2 direction
  ;***************************************************************
  ; PXE kernel provides direct access to Paddle1 variable
  temp_paddle = Paddle1

  ; Convert paddle value (0-128) to direction (0-15)
  p2_direction = temp_paddle / 8
  if p2_direction > 15 then p2_direction = 15

  ; Add direction offset to make 0=SSE (clockwise from there)
  p2_direction = (p2_direction + DIRECTION_OFFSET) & 15

  ; Set P2 velocity based on direction
  temp_dir = p2_direction
  gosub __Set_P2_Velocity

  ;***************************************************************
  ;  Apply movement to Player 1
  ;***************************************************************
  p1_xpos = p1_xpos + p1_xvel
  p1_ypos = p1_ypos + p1_yvel

  ; Boundary checking for P1 (keep inside playfield)
  ; Updated for taller 176-line playfield
  if p1_xpos < 8 then p1_xpos = 8
  if p1_xpos > 150 then p1_xpos = 150
  if p1_ypos < 10 then p1_ypos = 10
  if p1_ypos > 160 then p1_ypos = 160

  ;***************************************************************
  ;  Apply movement to Player 2
  ;***************************************************************
  p2_xpos = p2_xpos + p2_xvel
  p2_ypos = p2_ypos + p2_yvel

  ; Boundary checking for P2
  if p2_xpos < 8 then p2_xpos = 8
  if p2_xpos > 150 then p2_xpos = 150
  if p2_ypos < 10 then p2_ypos = 10
  if p2_ypos > 160 then p2_ypos = 160

  ;***************************************************************
  ;  Update sprite positions
  ;***************************************************************
  player0x = p1_xpos
  player0y = p1_ypos
  player1x = p2_xpos
  player1y = p2_ypos

  ;***************************************************************
  ;  Draw the screen and loop
  ;***************************************************************
  drawscreen
  goto __Main_Loop


  ;***************************************************************
  ;  SUBROUTINES
  ;***************************************************************

  ;***************************************************************
  ;  Set Player 1 velocity based on direction (0-15)
  ;  temp_dir contains direction
  ;  Uses constant velocity (MOVE_SPEED)
  ;
  ;  NEW Direction map (clockwise from SSE):
  ;  0=SSE, 1=S, 2=SSW, 3=SW, 4=WSW, 5=W, 6=WNW, 7=NW
  ;  8=NNW, 9=N, 10=NNE, 11=NE, 12=ENE, 13=E, 14=ESE, 15=SE
  ;
  ;  INTERNAL mapping (still N=0 in the velocity tables):
  ;  Direction gets offset by +7 before lookup, so:
  ;  User 0 (SSE) → Internal 7 (SSE)
  ;  User 1 (S)   → Internal 8 (S)
  ;  etc.
  ;***************************************************************
__Set_P1_Velocity
  on temp_dir goto __P1V_0 __P1V_1 __P1V_2 __P1V_3 __P1V_4 __P1V_5 __P1V_6 __P1V_7 __P1V_8 __P1V_9 __P1V_10 __P1V_11 __P1V_12 __P1V_13 __P1V_14 __P1V_15

__P1V_0   ; North (0,-1)
  p1_xvel = 0 : p1_yvel = 255 : return
__P1V_1   ; NNE (1,-2)
  p1_xvel = 1 : p1_yvel = 254 : return
__P1V_2   ; NE (1,-1)
  p1_xvel = 1 : p1_yvel = 255 : return
__P1V_3   ; ENE (2,-1)
  p1_xvel = 2 : p1_yvel = 255 : return
__P1V_4   ; East (1,0)
  p1_xvel = 1 : p1_yvel = 0 : return
__P1V_5   ; ESE (2,1)
  p1_xvel = 2 : p1_yvel = 1 : return
__P1V_6   ; SE (1,1)
  p1_xvel = 1 : p1_yvel = 1 : return
__P1V_7   ; SSE (1,2)
  p1_xvel = 1 : p1_yvel = 2 : return
__P1V_8   ; South (0,1)
  p1_xvel = 0 : p1_yvel = 1 : return
__P1V_9   ; SSW (-1,2)
  p1_xvel = 255 : p1_yvel = 2 : return
__P1V_10  ; SW (-1,1)
  p1_xvel = 255 : p1_yvel = 1 : return
__P1V_11  ; WSW (-2,1)
  p1_xvel = 254 : p1_yvel = 1 : return
__P1V_12  ; West (-1,0)
  p1_xvel = 255 : p1_yvel = 0 : return
__P1V_13  ; WNW (-2,-1)
  p1_xvel = 254 : p1_yvel = 255 : return
__P1V_14  ; NW (-1,-1)
  p1_xvel = 255 : p1_yvel = 255 : return
__P1V_15  ; NNW (-1,-2)
  p1_xvel = 255 : p1_yvel = 254 : return

  ;***************************************************************
  ;  Set Player 2 velocity based on direction (0-15)
  ;***************************************************************
__Set_P2_Velocity
  on temp_dir goto __P2V_0 __P2V_1 __P2V_2 __P2V_3 __P2V_4 __P2V_5 __P2V_6 __P2V_7 __P2V_8 __P2V_9 __P2V_10 __P2V_11 __P2V_12 __P2V_13 __P2V_14 __P2V_15

__P2V_0   ; North
  p2_xvel = 0 : p2_yvel = 255 : return
__P2V_1   ; NNE
  p2_xvel = 1 : p2_yvel = 254 : return
__P2V_2   ; NE
  p2_xvel = 1 : p2_yvel = 255 : return
__P2V_3   ; ENE
  p2_xvel = 2 : p2_yvel = 255 : return
__P2V_4   ; East
  p2_xvel = 1 : p2_yvel = 0 : return
__P2V_5   ; ESE
  p2_xvel = 2 : p2_yvel = 1 : return
__P2V_6   ; SE
  p2_xvel = 1 : p2_yvel = 1 : return
__P2V_7   ; SSE
  p2_xvel = 1 : p2_yvel = 2 : return
__P2V_8   ; South
  p2_xvel = 0 : p2_yvel = 1 : return
__P2V_9   ; SSW
  p2_xvel = 255 : p2_yvel = 2 : return
__P2V_10  ; SW
  p2_xvel = 255 : p2_yvel = 1 : return
__P2V_11  ; WSW
  p2_xvel = 254 : p2_yvel = 1 : return
__P2V_12  ; West
  p2_xvel = 255 : p2_yvel = 0 : return
__P2V_13  ; WNW
  p2_xvel = 254 : p2_yvel = 255 : return
__P2V_14  ; NW
  p2_xvel = 255 : p2_yvel = 255 : return
__P2V_15  ; NNW
  p2_xvel = 255 : p2_yvel = 254 : return


  ;***************************************************************
  ;  Setup Playfield - Full 40-pixel width border (176 lines)
  ;***************************************************************
__Setup_Playfield
  playfield:
  XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  X......................................X
  XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
end
  return
